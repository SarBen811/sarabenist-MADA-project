---
title: "Sara Benist MADA Project"
subtitle: "Tuberculosis Burden and Health Inequality Measures"
author: Sara Benist
date: "`r Sys.Date()`"
format:
  docx:
    toc: false
    number-sections: true
    highlight-style: github
bibliography: ../sarabenist-MADA-project_references.bib
csl: ../apa.csl
---


```{r, echo=FALSE, message=FALSE}
# load a few R packages
library(here)
library(knitr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidymodels)
```

# Questions for Dr. Handel
I would like to be able to predict the main TB outcomes based on the health equity indicators (ex: level of TB incidence predicted from % of people with drug-resistant strains), but I cannot join the rows together correctly. When I tried bind_rows() on the one of the countries to see if it would work, the outcome rows are still separated and if I remove year to force everything onto the same row, I have 90 variables and they are grouped within the same cell. I added an example below. Do you have any advice? 

```{r}
#path to data
data_location <- here::here("data","raw_data","202206-repository-tb.xlsx")

#load data and assign to rawdata
rawdata <- readxl::read_excel(data_location)

#without year removed: outcomes remain on a separate row
test <- rawdata %>% 
  select(c(setting, year, indicator_name,
           dimension, subgroup,
           estimate)) %>% 
  pivot_wider(names_from = c("indicator_name", "dimension", "subgroup"), values_from = "estimate") %>% 
  filter(setting == "Afghanistan") %>% bind_rows()
test

#with year removed: cells contain multiple observations
test2 <- rawdata %>% 
  select(c(setting, indicator_name,
           dimension, subgroup,
           estimate)) %>% 
  pivot_wider(names_from = c("indicator_name", "dimension", "subgroup"), values_from = "estimate") %>% 
  filter(setting == "Afghanistan") %>% bind_rows()
test2
```
If it is not feasible, I will be analyzing TB outcomes separately from indicators instead.

# Summary/Abstract

Full summary to be added (TBA): background of topic, objective of project, quick overview of methods, main findings

{{< pagebreak >}}

# Introduction

## General Background Information

Tuberculosis is an infectious disease caused by *Mycobacterium tuberculosis* and is the leading infectious cause of death in the world even though the disease is both treatable and curable[@WHO2022]. Approximately 10 million people are infected each year, and 1.5 million die from the disease [@WHO2022]. Humanity has been impacted by TB for centuries, but the burden of disease is not equal across countries and populations [@WHO2022b]. The World Health Organization marked 30 countries as having highest burden of TB due to the number of cases, presence of multi-drug resistance strains, and the high mortality within certain populations such as HIV [@WHO2021b]. To understand more about why some countries or groups of people experience the higher burden, the World Health Organization gathered data on several health equity indicators subgroups. The Global Tuberculosis Programme houses the End TB Strategy with a goal to eradicating TB. Their current objective is to reduce TB incidence by 80% and TB deaths by 90% by 2030 [@WHO2022c]. Previous research has focused on trends in TB outcomes,; this project will explore and analyze the disparities within the indicators based on subgroup and burden of disease as well as analyizing trends in tuberculosis outcomes.

## Description of data and data source

The World Health Organization collected data on the inequity surrounding tuberculosis, HIV, and malaria for the [State of inequality report](https://www.who.int/data/inequality-monitor/publications/report_2021_hiv_tb_malaria), and I will be exploring the dataset for TB [@WHO2021]. More information about the data can be found [here](https://heatrepository.blob.core.windows.net/documents/data-repository-indicator-list.pdf?sp=r&st=2022-06-07T14:16:36Z&se=2023-12-30T23:16:36Z&spr=https&sv=2020-08-04&sr=b&sig=4kzThU1QDo55UOQyhWcUd8rPWJ9LxUZdRRI3zl6wKNs%3D) under "Tuberculosis Indicators" [@WHOTBData]. The dataset can be found [here](https://www.who.int/data/inequality-monitor/data#PageContent_C158_Col00) under "Tuberculosis Indicators" [@WHOTBData].

For the tuberculosis dataset, the data was collected from the WHO Global TB programme, TB prevalence surveys, country-specific TB programmes, the WHO Health Equity Monitor database, TB patient cost surveys, and other sources [@WHO2021]. The WHO organized the dataset to be used with the Health Equity Assessment Toolkit which is the built in data analysis and exploration tool. The database contains 10 variables regarding the burden, detection, prevention, knowledge, and social protection and observations for 194 countries over various years. The observations for each variable is further separated by up 7 inequality domains. Not all countries have data available for each year or for each inequality domain. The dataset contains a total of 7473 observations.

## Questions/Hypotheses to be addressed
*update depending on ability to bind indicators with outcomes*

Research question: Does high disparities between inequality measures show high correlation to TB incidence, prevalence, and mortality of a country? How do these relationships differ for high burden countries compared to all countries?

The overall outcome I would study is TB mortality since effective health programs ideally reduce disease-specific mortality. By the end of my analysis, I would like to be able to identify populations that could be a focus of TB health improvement programs. Other outcomes I would like to explore include regional differences in drug-resistant TB and the attitudes and perceptions for high burden areas compared to medium or low burden regions.

In addition to the inequality and indicator predictors provided with the dataset, I would like to examine differences in TB outcomes based on level of TB burden. This can be completed by subsetting the high burden countries into a smaller data set.

In the data, the pattern I would expect to see is a higher burden of disease on populations with greater inequality. However, I am not confident in predicting how the indicator categories, specifically the TB attitudes and perceptions, would relate to the TB outcomes.

{{< pagebreak >}}

# Methods

The data cleaning will consist of widening the data set so each TB indicator is placed in a column in order to explore the indicators separately. The data set will also be split into a full data set containing all countries (wide_data) and high burden countries (highburden). The data will then be summarized and described using exploratory analysis approaches such as graphs, plots, and tables. The statistical analysis will use cross-validation and decision tree modeling to model TB outcomes based on the available predictor variables. A similar approach will be used for the health equity indicators as outcomes.

## Data aquisition, import, and cleaning

The WHO dataset can be found [here](o%20https://www.who.int/data/inequality-monitor/data#PageContent_C158_Col00) under "Tuberculosis Indicators". This data was downloaded and stored into the `raw_data` folder of the repository as `rawdata`. Information on the indicators, social determinants dimensions, and subgroups can be found in the `raw_data` folder under `202206-metadata-tb.pdf`

```{r load data}
#path to data
data_location <- here::here("data","raw_data","202206-repository-tb.xlsx")

#load data and assign to rawdata
rawdata <- readxl::read_excel(data_location)

str(rawdata)
```

Please see `processingfile.qmd` for full code describing data importing and cleaning.

The `rawdata` file contains information on the country, year of data collection, the indicator they are studying, the social determinants of health they are considering, and the subgroup of each dimension. The dataset is mostly complete with only a few main variables missing data points. The indicators being studied are shown below.

```{r}
#look at what indicators are in the dataset
unique(rawdata$indicator_name)
```

For the main part of the data cleaning, I used `pivot_wider()` to allow each indicator to have its own column, and subset the high burden countries (as indicated by the WHO) into a new object called `highburden`. I also checked each indicator using `filter()`, `select()`, and `summary()` functions. These methods will allow for deeper exploration of each indicator in order to explore trends and patterns for each subgroup. An example of the data cleaning is shown below.

```{r}
wide_data <- rawdata %>% 
  select(c(setting, year, indicator_name,
           indicator_abbr, dimension, subgroup,
           estimate, population)) %>% 
  pivot_wider(names_from = "indicator_name", values_from = "estimate")
head(wide_data)

# BCG coverage indicator
wide_data %>% 
  filter(indicator_abbr == "bcg") %>% 
  select(c(1,2,3,4,5,6,7)) %>% 
  summary()
```

Due to the `pivot_wider()` function, there was several missing observations for countries and years that had data for only some subgroups (ex: data on males but no data on females). Since I will be maintaining all the indicators in their own data set, `drop_na()` would remove all data points. Instead, I will handle missing data points after exploring the data further.

The processed and cleaned data was then saved into the `processed_data` folder under `processeddata.rda` to be used during the exploratory analysis phase. I have loaded the processed data below.

```{r}
#path to data
data_location <- here::here("data","processed_data","processeddata.rda")
#load data. 
load(data_location)
```

## Statistical analysis

For the statistical analysis of the data, I created decision tree models for the main outcomes (TB incidence, TB mortality, and TB prevalence) based on the subgroups of the indicator and tuned the models using cross-validation folds. The data was initially split into test/train data sets to better evaluate model performance. An example is shown below. This method was repeated for the `wide_data` and `highburden` countries.

```{r}
# fit linear model using TB incidence as outcome, subgroup as predictor
lm_mod <- linear_reg() #set linear regression

#fit model with high burden countries
inclm_fit <- lm_mod %>% 
  fit(`TB incidence (new infections per 100 000 population)` ~ subgroup,
      data = highburden) #fit linear model
incfittable <- tidy(inclm_fit) 
print(incfittable) #produce tidy table of fitted model
```

Other indicators were also analyzed and fit to a decision tree model using the same methods.

```{r}
# fit linear model with BCG coverage as outcome, subgroups as predictors

#fit model with high burden countries
BCGlm_fit <- lm_mod %>% 
  fit(`BCG immunization coverage among one-year-olds (%)` ~ subgroup,
      data = highburden) #fit linear model
BCGfittable <- tidy(BCGlm_fit) 
print(BCGfittable) #produce tidy table of fitted model
```

I would still like to try to manipulate the data set so I can use the social determinant indicators as predictors for the main outcomes. This will most likely be limited to the high burden countries.

{{< pagebreak >}}

# Results

## Exploratory/Descriptive analysis

Please see `exploratory_analysis.qmd` for full code describing data exploratory analysis.

The `processedcode` was loaded into the `exploratory_analysis.qmd` file which pulls coding from the `exploratoryanalysis.r` script.

```{r}
#Path to data.
data_location <- here::here("data","processed_data","processeddata.rda")
#load data
load(data_location)
```

For each indicator, I produced a summary table using `skim()` to determine the number of dimensions and subgroups as well as the summary statistics to see any overall trends in the data. The summary tables are stored in the `results` folder. An example of the code is shown below.

```{r}
#incidence summary and save to file location
summary_inc <- skimr::skim(wide_data$`TB incidence (new infections per 100 000 population)`)
print(summary_inc)

#mortality summary and save to file location
summary_mort <- skimr::skim(wide_data$`TB mortality (deaths per 100 000 population)`)
print(summary_mort)
```

The population for most variables were relatively low and skewed to the right. The TB incidence and mortality indicators also showed a skewed distribution. The highest incidence rate was 908 cases/100,000 and highest mortality rate was 140 deaths/100,000.

After getting an overview of the indicators, I wanted to explore the differences between subgroups and start identifying the largest disparities. Using `ggplot()`, I created plots of the indicators separated by dimension and subgroup. For most variables, these disparities were described using the `boxplot()` function as shown below.

```{r}
p13 <- highburden %>%
  filter(!dimension %in% c("Age (2 groups) (0-15+)", "TB drug resistance", "Sex")) %>%
  ggplot(aes(x=dimension,
             y = `People who report TB is spread through coughing - Female (%)`,
             fill = subgroup)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90))   
plot(p13) # plots knowledge about TB by dimension and subgroup for females
```

The main outcomes of interest for TB incidence, mortality, and prevalence were plotted using the `geom_point()` function as shown below.

```{r}
p6 <- highburden %>% 
  filter(dimension %in% "Sex") %>%
  filter(indicator_abbr == "mortality") %>% 
  select(c(1,2,3,4,5,6,13)) %>% 
  ggplot(aes(x=fct_reorder(
  setting, `TB mortality (deaths per 100 000 population)`),
  y = `TB mortality (deaths per 100 000 population)`,
  color = subgroup)) +
    geom_point()+
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_brewer(palette = "Spectral")+
  xlab("setting")
plot(p6) #plots mortality by country from lowest mortality to highest, colored by subgroup
```

Most indicators showed the greatest disparities due to economic status and education level. 

## Basic statistical analysis
*update depending on binding outcomes and predictors: will probably do linear model predictions from TB outcomes from one indicator if possible. otherwise will do line*

The linear models summary for TB incidence are listed below.The high burden model has the linear equation of `TB incidence = 194 + 126(Male)` where male would equal 1. The full data model has the linear equation of `TB incidence = 82.6 + 48(Male)`. Based on the p-value for the subgroup variable, sex has a significant association with TB incidence in both models. Males having higher TB incidence is congruent with the exploratory analysis findings. The full model has smaller coefficients compared to `highburden` model.

```{r}
readRDS(file = here("results", "model fit tables", "incfittable.rds")) #TB incidence model for high burden countries
readRDS(file = here("results", "model fit tables", "incfittableFD.rds")) #TB incidence model for full data
```

The fitted model summaries below are the TB mortality for high burden countries and full data. For high burden countries, the linear equation is `TB mortality = 23.6 + 14.9(Male)`; for the full data model, the linear equation is `TB mortality = 9.98 + 6.43(Male)`. Sex is a statistically significant predictor of TB mortality (p-values \<0.05), but this does not consider any other factors. The next step in my analysis would be to rearrange the data set so I can predict the main outcomes using the sociodemographic indicators.

```{r}
readRDS(file = here("results", "model fit tables", "mortfittable.rds")) #TB mortality model for high burden countries
readRDS(file = here("results", "model fit tables", "mortfittableFD.rds")) #TB mortality model for full data
```

The last outcome model I fitted was TB prevalence for high burden countries and the full data. For high burden countries, the linear equation is `TB Prevalence = 399 + 151(Urban)` with urban residences receiving a 1 and rural residences receiving a 0. The full data model has an equation of `TB Prevalence = 410 + 95.5(Urban)`.

```{r}
readRDS(file = here("results", "model fit tables", "prevfittable.rds")) #TB prevalence model for high burden countries
readRDS(file = here("results", "model fit tables", "prevfittableFD.rds")) #TB prevalence model for full data
```

The models can be further explored by including `setting` as a predictor, shown in the prediction model below. The prediction model is basic prediction of TB incidence from subgroup and setting. As an example, I predicted the incidence for females and males in India (shown in the plot). The estimates for males (249.3660; CI = 139.68336, 359.0486) and females (123.1038; CI = 13.42112, 232.7864) are shown using `geom_point()` and `geom_errorbar()`. I need to explore the prediction modelling further before attempting to predict my main outcomes with more variables.

```{r}
#prediction model for TB incidence with subgroup and setting as predictors
predinclm_fit <- lm_mod %>% 
  fit(`TB incidence (new infections per 100 000 population)` ~ subgroup + setting,
      data = highburden) #fit linear model
predincfittable <- tidy(predinclm_fit) 
print(predincfittable)

#prediction plot using the above model estimating TB incidence for females and males in India
readRDS(file = here("results", "model fit tables", "prediction1.rds")) 
```

## Full analysis

For the majority of the statistical analysis, the tuberculosis outcomes and the health equity indicators with high disparity between subgroups (as identified during the exploratory analysis) were modeled and tuned using the decision tree model and cross-validation methods from the `tidymodels` guide. The models were all used the training data to tune the cost_complexity and tree_depth parameters to find the model with the lowest value of RMSE. An example output is shown below.

```{r}
#tree plot models for full data TB incidence
readRDS(file = here("results", "tune plots", "wdinctreeplot.rds")) 
#tree plot models for high burden TB incidence
readRDS(file = here("results", "tune plots", "hbinctreeplot.rds"))
```



Please refer to the `statistical_analysis.qmd` for the full code and results.

A summary of the model performances are shown below. The full data set models are marked with 'wd' and the high burden models are marked as 'hb'. The outcomes being modeled are abbreviated in the `model` column. The best performing model predicted prevalence to notification ratio for the full data set (RMSE = 0.971). The TB outcome models all performed poorly in predicting TB incidence, mortality, and prevalence. This is most likely due to the only significant predictor being country.
```{r}
readRDS(file = here("results", "summaryrmse.rds")) #summary table of RMSE from decision tree models
```

The second research question was to explore the differences between the full data set and high burden countries. I hypothesized that the high burden models would have a higher performance because these countries have the highest concentration of TB cases. However, the high burden models consistently preformed worse than the full data models. This is most likely due to the lower amount of available data. 
{{< pagebreak >}}

# Discussion

## Summary and Interpretation

TBA: summary of findings and why it matters

## Strengths and Limitations

TBA: strengths and limitations of analysis

## Conclusions

TBA: take away messages, citations from bibtex

{{< pagebreak >}}

# References
